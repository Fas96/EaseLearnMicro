<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE beans PUBLIC '-//SPRING//DTD BEAN//EN' 'http://www.springframework.org/dtd/spring-beans.dtd'>
<beans>
   <bean id="authenticationComponent" class="com.argo.r2eln.repo.security.authentication.KribbMISAuthenticationComponentImpl"
      parent="authenticationComponentBase">
       <property name="authenticationDao">
         <ref bean="authenticationDao" />
      </property>
      <property name="kribbCommonDao">
      	<ref bean="kribbCommonDAO"/>
      </property>
      <property name="allowGuestLogin">
         <value>${kribb.authentication.allowGuestLogin}</value>
      </property>
      <property name="nodeService">
         <ref bean="nodeService" />
      </property>
      <property name="personService">
         <ref bean="personService" />
      </property>
      <property name="transactionService">
         <ref bean="transactionService" />
      </property>
      <!--                                                                  -->
      <!-- A list of default users with admin rights.                       -->
      <!--                                                                  -->
      <!-- If the security framework is case sensitive these values should  -->
      <!-- be case sensitive user names. If the security framework is not   -->
      <!-- case sensitive these values should be the lower-case user names. -->
      <!--                                                                  -->
      <!-- By default this includes:                                        -->
      <!--    admin (the user name of default alfresco admin user)          -->
      <!--    administrator (the windows default admin user)                -->
      <!--                                                                  -->
      <!-- This assumes that user names are not case sensitive.             -->
      <!--                                                                  -->
      <property name="defaultAdministratorUserNames">
         <set>
            <value>${alfresco_user_store.adminusername}</value>
            <value>administrator</value>
         </set>
      </property>
	  <property name="defaultGuestUserNames">
	      <set>
	          <value>${alfresco_user_store.guestusername}</value>
	      </set>
	  </property>
   </bean>

   <!-- Wrapped version to be used within subsystem -->
   <bean id="AuthenticationComponent" class="org.springframework.transaction.interceptor.TransactionProxyFactoryBean">
      <property name="proxyInterfaces">
         <list>
            <value>org.alfresco.repo.security.authentication.AuthenticationComponent</value>
            <value>org.alfresco.repo.security.authentication.ntlm.NLTMAuthenticator</value>
         </list>
      </property>
      <property name="transactionManager">
         <ref bean="transactionManager" />
      </property>
      <property name="target">
         <ref bean="authenticationComponent" />
      </property>
      <property name="transactionAttributes">
         <props>
            <prop key="*">${server.transaction.mode.default}</prop>
         </props>
      </property>
   </bean>

   <bean id="authenticationDao" class="org.alfresco.repo.security.authentication.RepositoryAuthenticationDao">
      <property name="nodeService" ref="nodeService" />
      <property name="authorityService" ref="authorityService" />
      <property name="tenantService" ref="tenantService" />
      <property name="namespaceService" ref="namespaceService" />
      <property name="compositePasswordEncoder" ref="compositePasswordEncoder" />
      <property name="policyComponent" ref="policyComponent" />
      <property name="authenticationCache" ref="authenticationCache" />
      <property name="singletonCache" ref="immutableSingletonCache"/>
      <property name="transactionService">
         <ref bean="transactionService" />
      </property>
   </bean>

   <!-- Authentication service for chaining -->
   <bean id="localAuthenticationService" class="org.alfresco.repo.security.authentication.MutableAuthenticationServiceImpl">
      <property name="authenticationDao">
         <ref bean="authenticationDao" />
      </property>
      <property name="ticketComponent">
         <ref bean="ticketComponent" />
      </property>
      <property name="authenticationComponent">
         <ref bean="authenticationComponent" />
      </property>
      <property name="sysAdminParams">
         <ref bean="sysAdminParams" />
      </property>
   </bean>

   <!-- Datasource bean -->
    <bean id="baseKribbDataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close" abstract="true">
        <property name="driverClassName">
            <value>${kribb.db.driver}</value>
        </property>
        <property name="url">
            <value>${kribb.db.url}</value>
        </property>
        <property name="username">
            <value>${kribb.db.username}</value>
        </property>
        <property name="password">
            <value>${kribb.db.password}</value>
        </property>
        <property name="initialSize" >
            <value>${kribb.db.pool.initial}</value>
        </property>
        <property name="maxActive" >
            <value>${kribb.db.pool.max}</value>
        </property>
        <property name="minIdle" >
            <value>${db.pool.min}</value>
        </property>
        <property name="maxIdle" >
            <value>${db.pool.idle}</value>
        </property>
        <property name="defaultAutoCommit" >
            <value>false</value>
        </property>
        <property name="defaultTransactionIsolation" >
            <value>${db.txn.isolation}</value>
        </property>
        <property name="maxWait" >
            <value>${db.pool.wait.max}</value>
        </property>
        <property name="validationQuery" >
            <value>${kribb.pool.validate.query}</value>
        </property>
        <property name="timeBetweenEvictionRunsMillis" >
            <value>${db.pool.evict.interval}</value>
        </property>
        <property name="minEvictableIdleTimeMillis" >
            <value>${db.pool.evict.idle.min}</value>
        </property>
        <property name="numTestsPerEvictionRun" >
            <value>${db.pool.evict.num.tests}</value>
        </property>
        <property name="testOnBorrow" >
            <value>${db.pool.validate.borrow}</value>
        </property>
        <property name="testOnReturn" >
            <value>${db.pool.validate.return}</value>
        </property>
        <property name="testWhileIdle" >
            <value>${db.pool.evict.validate}</value>
        </property>
        <property name="removeAbandoned" >
            <value>${db.pool.abandoned.detect}</value>
        </property>
        <property name="removeAbandonedTimeout" >
            <value>${db.pool.abandoned.time}</value>
        </property>
        <property name="poolPreparedStatements" >
            <value>${db.pool.statements.enable}</value>
        </property>
        <property name="maxOpenPreparedStatements" >
            <value>${db.pool.statements.max}</value>
        </property>
        <property name="logAbandoned" >
            <value>${db.pool.abandoned.log}</value>
        </property>
    </bean>

    <!-- from Thor -->
    <bean id="kribbDefaultDataSource" parent="baseKribbDataSource" />

    <bean id="kribbDataSource" class="org.alfresco.config.JndiObjectFactoryBean">
        <property name="jndiName">
            <value>java:comp/env/jdbc/kribbDataSource</value>
        </property>
        <property name="defaultObject">
            <ref bean="kribbDefaultDataSource" />
        </property>
    </bean>

    <bean id="kribbDialectResourceLoader" class="org.alfresco.util.resource.HierarchicalResourceLoader">
        <property name="dialectBaseClass">
            <value>org.hibernate.dialect.Dialect</value>
        </property>
        <!--  Resolve the (perhaps auto detected) dialect class -->
        <property name="dialectClass">
           <value>${kribb.dialectClass}</value>
        </property>
    </bean>
    
    <!-- MyBatis config for Alfresco (using common datasource) -->
    <bean id="kribbSqlSessionFactory" class="org.alfresco.ibatis.HierarchicalSqlSessionFactoryBean">
        <property name="resourceLoader" ref="kribbDialectResourceLoader"/>
        <property name="dataSource" ref="kribbDataSource"/>
        <property name="configLocation">
            <value>classpath:alfresco/module/r2eln/ibatis/kribb-SqlMapConfig.xml</value>
        </property>
    </bean>

    <bean id="kribbSqlSessionTemplate" class="org.mybatis.spring.SqlSessionTemplate">
        <constructor-arg index="0" ref="kribbSqlSessionFactory"/>
    </bean>
    
   <bean id="kribbCommonDAO" class="org.alfresco.util.bean.HierarchicalBeanLoader">
      <property name="targetBeanName">
         <value>kribbCommonDAO.#bean.dialect#</value>
      </property>
      <property name="targetClass">
         <value>com.argo.r2eln.repo.dao.KribbCommonDAO</value>
      </property>
        <property name="dialectBaseClass">
            <value>org.hibernate.dialect.Dialect</value>
        </property>
        <property name="dialectClass">
			<value>${kribb.dialectClass}</value>
        </property>
   </bean>
   
   <bean id="kribbCommonDAO.org.hibernate.dialect.Dialect"
         class="com.argo.r2eln.repo.dao.KribbCommonDAOImpl">
      <property name="sqlSessionTemplate" ref="kribbSqlSessionTemplate"/>
   </bean>
   
   <bean id="kribbCommonDAO.org.hibernate.dialect.OracleDialect"
         class="com.argo.r2eln.repo.dao.KribbCommonDAOImpl$Oracle"
         parent="kribbCommonDAO.org.hibernate.dialect.Dialect">
   </bean>
   
      
</beans>