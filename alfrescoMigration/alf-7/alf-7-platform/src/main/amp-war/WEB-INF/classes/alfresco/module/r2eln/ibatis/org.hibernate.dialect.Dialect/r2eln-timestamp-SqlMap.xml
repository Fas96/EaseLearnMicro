<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="r2eln.timestamp">
	<sql id="search">
		<if test='type != null and type != "All"'>
			AND COMPLETE_YN = #{type}
		</if>
		<if test="type == null">
			AND COMPLETE_YN = 'F'
		</if>
		
		<if test="searchWord != null">
			<choose>
				<when test='searchType == "creator"'>
					AND UPPER(CREATOR) LIKE UPPER(#{searchWord}) || '%'
				</when>
				<when test='searchType == "reviewer"'>
					AND UPPER(REVIEWER) LIKE UPPER(#{searchWord}) || '%'
				</when>
			</choose>
		</if>
		
		<if test="startedAfter != null">
			AND INSDT >= TO_DATE(#{startedAfter}, 'YYYY-MM-DD')
		</if>

		<if test="startedBefore != null">
			AND INSDT &lt; TO_DATE(#{startedBefore}, 'YYYY-MM-DD') + 1
		</if>
		
		<if test="startedAfter == null and startedBefore == null">
			AND INSDT BETWEEN current_timestamp + '-6 months' AND current_date
		</if>
	</sql>
	
	<insert id="insertPnTimestamp" parameterType="hmap">
		INSERT INTO PN_TIMESTAMP(
			TS_ID,
			NODEREF,
			COMPLETE_YN,
			INSDT,
			FILENAME,
			CREATOR,
			LASTUPTDT,
			USER_ID,
			NT_PROJECT_ID
		)
		VALUES(
			(SELECT coalesce(MAX(TS_ID), 0 , MAX(TS_ID)) +1  FROM PN_TIMESTAMP),
			#{noderef},
			'N',
			current_date,
			#{filename},
			#{creator},
			#{lastuptdt},
			#{user_id},
			#{nt_project_id}
		)
	</insert>

    <select id="selectPnTimestampList" resultType="hmap" parameterType="hmap">
		SELECT T1.*
		FROM (SELECT ROW_NUMBER() OVER(ORDER BY TS_ID DESC) RNUM,
					 TS_ID,
			  		 NODEREF,
			   		 COMPLETE_YN,
			   		 INSDT,
			   		 FILENAME,
			   		 CREATOR,
			   		 REVIEWER
			  FROM PN_TIMESTAMP
			  WHERE 1 = 1
			  <include refid="search"/>) T1
		WHERE RNUM BETWEEN #{firstRecordIndex} + 1 AND #{lastRecordIndex}
    </select>
	
	<select id="selectPnTimestampTotalCount" parameterType="hmap" resultType="int">
		SELECT COUNT(1)
		FROM PN_TIMESTAMP
		WHERE 1 = 1
		<include refid="search"/>
	</select>
	
	<update id="updatePnTimestampCompleteYn" parameterType="hmap">
		UPDATE PN_TIMESTAMP
		SET COMPLETE_YN = #{complete_yn}
		WHERE TS_ID = #{ts_id}
	</update>
	
	<select id="selectPnTimestampExcelList" parameterType="hmap" resultType="hmap">
		SELECT FILENAME,
			   CREATOR,
			   REVIEWER,
			   TO_CHAR(INSDT, 'YYYY/MM/DD') CHAR_INSDT,
			   CASE COMPLETE_YN WHEN 'N' THEN '승인' WHEN 'Y' THEN '완료' WHEN 'F' THEN '오류' WHEN 'E' THEN '예외' END STATUS
		FROM PN_TIMESTAMP
		WHERE 1 = 1
		ORDER BY TS_ID DESC
	</select>
    
</mapper>