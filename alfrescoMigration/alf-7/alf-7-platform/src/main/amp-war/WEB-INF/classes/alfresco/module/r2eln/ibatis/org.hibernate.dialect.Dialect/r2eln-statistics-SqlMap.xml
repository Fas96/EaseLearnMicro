<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="r2eln.statistics">
	<sql id="search">				
		<if test="startedAfter != null">
			AND TO_DATE(statistics_dt, 'YYYY-MM-DD') >= TO_DATE(#{startedAfter}, 'YYYY-MM-DD')
		</if>
		<if test="startedBefore != null">
			AND TO_DATE(statistics_dt, 'YYYY-MM-DD') &lt; TO_DATE(#{startedBefore}, 'YYYY-MM-DD') + 1
		</if>
		<if test="user_id != null">
			AND user_id=#{user_id}
		</if>
		<if test="nt_project_id != null">
			AND nt_project_id=#{nt_project_id}
		</if>
		<if test="dept_nm != null">
			AND dept_nm=#{dept_nm}
		</if>
		<if test="startdt != null">
			AND project_startdt between #{startedAfter} and #{startedBefore}
			or project_enddt between #{startedAfter} and #{startedBefore}
		</if>
	</sql>
	
    <select id="selectPnStatisticsList" resultType="hmap" parameterType="hmap">
		select * from pn_statistics
		where 1=1
		<include refid="search" /> 
		order by statistics_dt
    </select>
    
    <select id="monthlyStat" resultType="hmap" parameterType="hmap">
		SELECT 
		    substring(statistics_dt, 1, 7) date, COALESCE(SUM(timestamp),0) count
		FROM
		    pn_statistics
		WHERE
		    1=1
		<include refid="search" /> 
		GROUP BY substring(statistics_dt, 1, 7)
		order by date
    </select>
    
    <select id="deptList" resultType="hmap" parameterType="hmap">
		SELECT 
		    dept_nm, COALESCE(SUM(timestamp),0) count
		FROM
		    pn_statistics
		WHERE
		    1=1
		<include refid="search" /> 
		GROUP BY dept_nm
		order by dept_nm
    </select>
    
    <select id="empList" resultType="hmap" parameterType="hmap">
		select user_id, user_nm, dept_nm, COALESCE(SUM(timestamp),0) count
		from pn_statistics
		where 1=1
		<include refid="search" />
		GROUP BY user_id, user_nm, dept_nm
		order by user_id
    </select>
    
    <select id="projList" resultType="hmap" parameterType="hmap">
		select nt_project_id, project_code, project_name, project_startdt, project_enddt, COALESCE(SUM(timestamp),0) count
		from pn_statistics
		where 1=1
		<include refid="search" />
		GROUP BY nt_project_id, project_code, project_name, project_startdt, project_enddt
		order by nt_project_id
    </select>
    
</mapper>